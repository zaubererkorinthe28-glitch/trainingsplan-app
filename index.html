<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trainings-App</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { margin:0; font-family:-apple-system,Arial,Helvetica,sans-serif; background:#f0f2f5; color:#222; }
.container { max-width:520px; margin:18px auto; padding:16px; }
header { background:#4caf50; color:#fff; border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.12); }
h1 { margin:0; font-size:20px; }
.nav { display:flex; gap:6px; margin:12px 0; flex-wrap:wrap; }
.nav button { flex:1; padding:8px; border-radius:8px; border:0; background:#eee; cursor:pointer; }
.nav button.active { background:#4caf50; color:#fff; }
.tab { display:none; }
.tab.active { display:block; }
input,select,textarea,button { width:100%; padding:8px; margin:6px 0; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; }
button.primary { background:#4caf50; color:#fff; border:0; cursor:pointer; }
.exercise-item { background:#fff; border:1px solid #ddd; padding:8px; border-radius:8px; margin:6px 0; }
.flex-row { display:flex; gap:8px; align-items:center; }
.flex-row input { flex:1; }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; z-index:20; }
.modal .card { background:#fff; padding:16px; border-radius:10px; width:92%; max-width:420px; }
.modal .row { margin-bottom:8px; }
.history-item { background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; margin:8px 0; }
.danger { background:#e74c3c; color:#fff; border:0; cursor:pointer; }
label.small { font-size:13px; color:#555; }
canvas { background:#fff; border-radius:8px; padding:8px; }
</style>
</head>
<body>
<div class="container">
<header><h1>üèãÔ∏è Trainings-App</h1></header>
<div class="nav">
<button id="btnPlans" class="active" onclick="showTab('plans')">Pl√§ne</button>
<button id="btnTraining" onclick="showTab('training')">Training</button>
<button id="btnProgress" onclick="showTab('progress')">Fortschritt</button>
<button id="btnHistory" onclick="showTab('history')">Historie</button>
<button id="btnOverview" onclick="showTab('overview')">√úbersicht</button>
</div>

<!-- PL√ÑNE -->
<div id="plans" class="tab active">
<h2>Neuen Plan erstellen</h2>
<input id="planName" placeholder="Planname">
<button class="primary" onclick="addPlan()">Plan hinzuf√ºgen</button>

<h3>Plan bearbeiten</h3>
<select id="selectPlan" onchange="loadPlan()"><option value="">-- Plan w√§hlen --</option></select>
<button class="danger" onclick="openDeleteModal()">Plan l√∂schen</button>


<h3>Plan umbenennen</h3>
<input id="renamePlanName" placeholder="Neuer Planname">
<button onclick="renamePlan()">Plan umbenennen</button>

<input id="exerciseName" placeholder="√úbung">
<input id="sets" type="number" placeholder="S√§tze">
<label class="small"><input id="bodyweight" type="checkbox"> K√∂rpergewicht</label>
<textarea id="notes" placeholder="Notizen zur √úbung"></textarea>
<button onclick="addExercise()">√úbung hinzuf√ºgen</button>

<div id="exercises"></div>
</div>

<!-- TRAINING -->
<div id="training" class="tab">
<h2>Training starten</h2>
<select id="selectTrainingPlan" onchange="loadTrainingPlan()"><option value="">-- Plan w√§hlen --</option></select>
<label class="small">üìÖ Trainingsdatum</label>
<input id="trainingDate" type="date">
<div id="trainingExercises"></div>
<button class="primary" onclick="saveTraining()">Training speichern</button>
</div>

<!-- FORTSCHRITT -->
<div id="progress" class="tab">
<h2>Fortschritt (plan√ºbergreifend)</h2>
<select id="exerciseSelectProgress" onchange="renderProgressChart()"><option value="">-- √úbung w√§hlen --</option></select>
<select id="displayMode" onchange="renderProgressChart()">
<option value="sum">Summe Wdh√óGewicht</option>
<option value="max">Max Gewicht</option>
</select>
<canvas id="chart" height="220"></canvas>
</div>

<!-- HISTORIE -->
<div id="history" class="tab">
<h2>Trainingshistorie</h2>
<div id="historyList"></div>
</div>

<!-- √úBERSICHT -->
<div id="overview" class="tab">
<h2>Alle Trainingspl√§ne</h2>
<div id="allPlans"></div>
</div>

<!-- Debug-Fenster -->
<div style="margin-top:20px; padding:10px; background:#fff; border:1px solid #ccc; border-radius:6px;">
  <h4>Debug Daten</h4>
  <button onclick="showDebugData()">Daten anzeigen</button>
  <pre id="debugOutput" style="white-space:pre-wrap; max-height:200px; overflow:auto;"></pre>
</div>


<!-- EXPORT / IMPORT -->
<div style="margin:12px 0">
<h3>Backup</h3>
<button onclick="exportData()" class="primary">Exportieren (JSON)</button>
<input type="file" id="importFile" style="margin-top:6px" onchange="importData(this)">
</div>
</div>

<!-- Modal: √úbung bearbeiten -->
<div id="editModal" class="modal">
<div class="card">
<h3>√úbung bearbeiten</h3>
<div class="row"><label class="small">Name</label><input id="editName"></div>
<div class="row"><label class="small">S√§tze</label><input id="editSets" type="number"></div>
<div class="row"><label class="small"><input id="editBodyweight" type="checkbox"> K√∂rpergewicht</label></div>
<div class="row"><label class="small">Notizen</label><textarea id="editNotes"></textarea></div>
<div style="display:flex;gap:8px;justify-content:space-between">
<button class="primary" onclick="saveExerciseEdit()">Speichern</button>
<button onclick="closeEditModal()">Abbrechen</button>
</div>
</div>
</div>

<script>
let plans = JSON.parse(localStorage.getItem('plans') || '{}');
let chart = null;
let editing = { plan: null, index: null };
let planToDelete = null;

function saveData() { localStorage.setItem('plans', JSON.stringify(plans)); }

function showTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('btn'+id.charAt(0).toUpperCase()+id.slice(1)).classList.add('active');

  if(id==='plans') renderPlanSelectors();
  if(id==='progress') updateExerciseSelectProgress(); // hier
  if(id==='history') renderHistory();
  if(id==='overview') renderOverview();
}



// --- Planverwaltung ---
function renderPlanSelectors() {
  const sel = document.getElementById('selectPlan');
  const selTrain = document.getElementById('selectTrainingPlan');
  sel.innerHTML = '<option value="">-- Plan w√§hlen --</option>';
  selTrain.innerHTML = '<option value="">-- Plan w√§hlen --</option>';
  for (let p in plans) {
    sel.innerHTML += `<option value="${p}">${p}</option>`;
    selTrain.innerHTML += `<option value="${p}">${p}</option>`;
  }
  loadPlan();
}

function addPlan() {
  const name = document.getElementById('planName').value.trim();
  if (!name) return alert('Planname fehlt');
  if (plans[name]) return alert('Plan existiert bereits');
  plans[name] = { exercises: [], history: [] };
  saveData();
  document.getElementById('planName').value = '';
  renderPlanSelectors();
}

function openDeleteModal() {
  const sel = document.getElementById('selectPlan').value;
  if (!sel) return alert('Bitte zuerst einen Plan ausw√§hlen.');
  planToDelete = sel;
  document.getElementById('deletePlanText').innerHTML =
    `M√∂chtest du den Plan <strong>"${sel}"</strong> wirklich l√∂schen?`;
  document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
  planToDelete = null;
}

function deletePlanConfirmed() {
  if (!planToDelete) return;
  delete plans[planToDelete];
  saveData();
  renderPlanSelectors();
  document.getElementById('exercises').innerHTML = '';
  closeDeleteModal();
  alert(`Plan "${planToDelete}" wurde gel√∂scht.`);
}

function loadPlan() {
  const plan = document.getElementById('selectPlan').value;
  const container = document.getElementById('exercises');
  container.innerHTML = '';
  if (!plan || !plans[plan]) return;
  plans[plan].exercises.forEach((ex, i) => {
    const el = document.createElement('div');
    el.className = 'exercise-item';
    el.innerHTML = `<strong>${ex.name}</strong> ‚Äî ${ex.sets} S√§tze ${ex.bodyweight ? '(K√∂rpergewicht)' : ''}
    <div style="margin-top:6px"><small>${ex.notes || ''}</small></div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button onclick="openEditModal('${plan}',${i})">Bearbeiten</button>
      <button onclick="deleteExercise('${plan}',${i})" class="danger">L√∂schen</button>
    </div>`;
    container.appendChild(el);
  });
}

function addExercise() {
  const plan = document.getElementById('selectPlan').value;
  if (!plan) return alert('Bitte Plan w√§hlen');
  const name = document.getElementById('exerciseName').value.trim();
  const sets = parseInt(document.getElementById('sets').value);
  const bodyweight = document.getElementById('bodyweight').checked;
  const notes = document.getElementById('notes').value.trim();
  if (!name || !sets) return alert('√úbung & S√§tze erforderlich');
  plans[plan].exercises.push({ name, sets, bodyweight, notes });
  saveData();
  document.getElementById('exerciseName').value = '';
  document.getElementById('sets').value = '';
  document.getElementById('bodyweight').checked = false;
  document.getElementById('notes').value = '';
  loadPlan();
  updateExerciseSelectProgress();
}

function deleteExercise(plan, i) {
  if (!confirm('√úbung l√∂schen?')) return;
  plans[plan].exercises.splice(i, 1);
  saveData();
  loadPlan();
  updateExerciseSelectProgress();
}

// --- Edit Modal ---
function openEditModal(plan, i) {
  editing = { plan, index: i };
  const ex = plans[plan].exercises[i];
  document.getElementById('editName').value = ex.name;
  document.getElementById('editSets').value = ex.sets;
  document.getElementById('editBodyweight').checked = ex.bodyweight;
  document.getElementById('editNotes').value = ex.notes || '';
  document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
  editing = { plan: null, index: null };
}

function saveExerciseEdit() {
  const ex = plans[editing.plan].exercises[editing.index];
  ex.name = document.getElementById('editName').value.trim();
  ex.sets = parseInt(document.getElementById('editSets').value) || ex.sets;
  ex.bodyweight = document.getElementById('editBodyweight').checked;
  ex.notes = document.getElementById('editNotes').value.trim();
  saveData();
  closeEditModal();
  loadPlan();
  updateExerciseSelectProgress();
}

// --- Rename Modal ---
function openRenameModal() {
  const sel = document.getElementById('selectPlan').value;
  if (!sel) return alert('Bitte zuerst einen Plan ausw√§hlen.');
  document.getElementById('renamePlanInput').value = sel;
  document.getElementById('renameModal').style.display = 'flex';
}

function closeRenameModal() {
  document.getElementById('renameModal').style.display = 'none';
}

function renamePlan() {
  const oldName = document.getElementById('selectPlan').value;
  const newName = document.getElementById('renamePlanInput').value.trim();
  if (!oldName) return alert('Kein Plan ausgew√§hlt.');
  if (!newName) return alert('Neuer Name fehlt.');
  if (plans[newName] && newName !== oldName) return alert('Ein Plan mit diesem Namen existiert bereits.');
  if (newName === oldName) return closeRenameModal();
  plans[newName] = JSON.parse(JSON.stringify(plans[oldName]));
  delete plans[oldName];
  saveData();
  renderPlanSelectors();
  document.getElementById('selectPlan').value = newName;
  loadPlan();
  closeRenameModal();
  alert(`Plan "${oldName}" wurde in "${newName}" umbenannt.`);
}

// --- Training ---
function loadTrainingPlan() {
  const plan = document.getElementById('selectTrainingPlan').value;
  const cont = document.getElementById('trainingExercises');
  cont.innerHTML = '';
  if (!plan || !plans[plan]) return;
  const today = new Date().toISOString().split('T')[0];
  if (!document.getElementById('trainingDate').value) document.getElementById('trainingDate').value = today;
  plans[plan].exercises.forEach((ex, exIdx) => {
    const wrapper = document.createElement('div');
    wrapper.className = 'exercise-item';
    let inner = `<strong>${ex.name}</strong> ${ex.bodyweight ? '(K√∂rpergewicht)' : ''}<div style="margin-top:6px">`;
    for (let s = 1; s <= ex.sets; s++) {
      if (!ex.bodyweight) {
        inner += `<div class="flex-row">Satz ${s}: <input type="number" id="w_${exIdx}_${s}" placeholder="Gewicht (kg)"><input type="number" id="r_${exIdx}_${s}" placeholder="Wdh"></div>`;
      } else {
        inner += `<div class="flex-row">Satz ${s}: <input type="number" id="r_${exIdx}_${s}" placeholder="Wdh"></div>`;
      }
    }
    inner += `<textarea id="note_${exIdx}" placeholder="Notizen (optional)">${ex.notes || ''}</textarea></div>`;
    wrapper.innerHTML = inner;
    cont.appendChild(wrapper);
  });
}

function saveTraining() {
  const plan = document.getElementById('selectTrainingPlan').value;
  if (!plan) return alert('Bitte Plan w√§hlen');

  const date = document.getElementById('trainingDate').value || new Date().toISOString().split('T')[0];
  const exercisesSaved = [];

  plans[plan].exercises.forEach((ex, exIdx) => {
    const setsData = [];
    for (let s = 1; s <= ex.sets; s++) {
      const reps = parseInt(document.getElementById(`r_${exIdx}_${s}`)?.value) || 0;
      const weight = ex.bodyweight ? 0 : (parseFloat(document.getElementById(`w_${exIdx}_${s}`)?.value) || 0);
      if (reps > 0 || weight > 0) {
        setsData.push({ weight, reps });
      }
    }

    const note = document.getElementById(`note_${exIdx}`)?.value || '';

    // üëá Auch wenn nichts eingetragen wurde, speichern wir die √úbung mit leerem Satzarray
    exercisesSaved.push({
      name: ex.name,
      setsData,
      note,
      bodyweight: ex.bodyweight
    });
  });

  // üëá Sicherstellen, dass das History-Array existiert
  if (!plans[plan].history) plans[plan].history = [];

  plans[plan].history.push({ date, exercises: exercisesSaved });
  saveData();

  alert('Training gespeichert!');
  renderHistory();
  updateExerciseSelectProgress();
}


// --- Historie ---

function renderHistory() {
  const historyDiv = document.getElementById('historyList');
  historyDiv.innerHTML = '';

  let entriesFound = false;

  for (let planName in plans) {
    const history = plans[planName].history || [];
    if (history.length === 0) continue;

    entriesFound = true;

    const planHeader = document.createElement('h3');
    planHeader.textContent = `üìò ${planName}`;
    historyDiv.appendChild(planHeader);

    history.slice().reverse().forEach((session, index) => {
      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `<strong>${session.date}</strong>`;

      if (!session.exercises || session.exercises.length === 0) {
        item.innerHTML += `<div style="margin-left:10px;">Keine √úbungen</div>`;
      } else {
        session.exercises.forEach(ex => {
          const setsText = ex.setsData && ex.setsData.length
            ? ex.setsData.map(s => `${s.weight}kg √ó ${s.reps}`).join(', ')
            : '‚Äì';
          const note = ex.note ? `<div><em>${ex.note}</em></div>` : '';
          item.innerHTML += `
            <div style="margin-left:10px;">
              <strong>${ex.name}</strong>: ${setsText} ${note}
            </div>`;
        });
      }

      // L√∂schen-Button f√ºr diese Session
      item.innerHTML += `<button class="danger" style="margin-top:5px;" onclick="deleteHistory('${planName}',${history.length - 1 - index})">Eintrag l√∂schen</button>`;

      historyDiv.appendChild(item);
    });
  }

  if (!entriesFound) {
    historyDiv.innerHTML = '<p>Keine Trainingshistorie vorhanden.</p>';
  }
}


function deleteHistory(plan, index) {
  if (!confirm('Eintrag l√∂schen?')) return;
  plans[plan].history.splice(index, 1);
  saveData();
  renderHistory();
  updateExerciseSelectProgress();
}

// --- Fortschritt ---

function updateExerciseSelectProgress() {
  const sel = document.getElementById('exerciseSelectProgress');
  sel.innerHTML = '<option value="">-- √úbung w√§hlen --</option>';

  const exercisesSet = new Set();
  for (let planName in plans) {
    (plans[planName].exercises || []).forEach(ex => exercisesSet.add(ex.name));
  }

  Array.from(exercisesSet).forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });

  // Auto-render f√ºr die erste √úbung, falls vorhanden
  if (sel.value) renderProgressChart();
}


let chart; // globale Chart-Variable

function renderProgressChart() {
  const select = document.getElementById('exerciseSelectProgress');
  const name = select.value;
  if (!name) {
    if (chart) chart.destroy();
    const ctx = document.getElementById('chart').getContext('2d');
    ctx.clearRect(0, 0, 500, 300);
    ctx.font = '16px Arial';
    ctx.fillText('Bitte √úbung ausw√§hlen', 40, 150);
    return;
  }

  const mode = document.getElementById('displayMode').value;
  const labels = [];
  const data = [];

  for (let planName in plans) {
    const history = plans[planName].history || [];
    history.forEach(entry => {
      const ex = entry.exercises.find(e => e.name === name);
      if (!ex || !ex.setsData || ex.setsData.length === 0) return;

      let value = 0;
      if (mode === 'sum') {
        value = ex.setsData.reduce((sum, s) => sum + s.weight * s.reps, 0);
      } else {
        value = Math.max(...ex.setsData.map(s => s.weight));
      }

      labels.push(`${entry.date} (${planName})`);
      data.push(value);
    });
  }

  const ctx = document.getElementById('chart').getContext('2d');
  if (chart) chart.destroy();

  if (data.length === 0) {
    ctx.clearRect(0, 0, 500, 300);
    ctx.font = '16px Arial';
    ctx.fillText('Keine Trainingsdaten f√ºr diese √úbung vorhanden', 40, 150);
    return;
  }

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: name,
        data: data,
        borderColor: '#4caf50',
        borderWidth: 2,
        fill: false,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, title: { display: true, text: mode === 'sum' ? 'Gesamtvolumen (kg√óWdh)' : 'Max Gewicht (kg)' } },
        x: { title: { display: true, text: 'Datum / Plan' } }
      }
    }
  });
}


// --- √úbersicht ---
function renderOverview() {
  const div = document.getElementById('allPlans');
  div.innerHTML = '';
  for (let p in plans) {
    const card = document.createElement('div');
    card.className = 'exercise-item';
    card.innerHTML = `<strong>${p}</strong> ‚Äî ${plans[p].exercises.length} √úbungen`;
    div.appendChild(card);
  }
}

// --- Import / Export ---
function exportData() {
  const dataStr = JSON.stringify(plans, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'trainings_backup.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (!confirm('Importiert werden alle Pl√§ne. Alte Daten gehen verloren. Fortfahren?')) return;
      plans = imported;
      saveData(); renderPlanSelectors(); renderHistory(); updateExerciseSelectProgress(); renderOverview();
      alert('Import erfolgreich!');
    } catch (err) { alert('Fehler beim Import: ' + err.message); }
  };
  reader.readAsText(file);
}

// --- Klick au√üerhalb Modal schlie√üt Fenster ---
window.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) e.target.style.display = 'none';
});

function showDebugData() {
  const output = document.getElementById('debugOutput');
  output.textContent = JSON.stringify(plans, null, 2);
}



// --- Initialisierung ---
renderPlanSelectors();
updateExerciseSelectProgress();
renderHistory();
renderOverview();
</script>



</body>
</html>
